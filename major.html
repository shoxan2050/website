<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCy8SLCFTgc_mB8B4JJqrUGsX5Lr2NUuPo",
    authDomain: "space0411-a00b1.firebaseapp.com",
    databaseURL: "https://space0411-a00b1-default-rtdb.firebaseio.com",
    projectId: "space0411-a00b1",
    storageBucket: "space0411-a00b1.firebasestorage.app",
    messagingSenderId: "1018550863390",
    appId: "1:1018550863390:web:d023ce44fbe8ce7171d00f",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const roleBox = document.getElementById("role-box");
  const userNameEl = document.getElementById("user-name");

  const teacherBtn = document.getElementById("teacher-btn");
  const studentBtn = document.getElementById("student-btn");

  // ðŸ”‘ AUTH + ROLE CHECK
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "/signin.html";
      return;
    }

    // Ism familiya (agar yoâ€˜q boâ€˜lsa)
    userNameEl.textContent = user.displayName || "Foydalanuvchi";

    const roleRef = ref(db, `users/${user.uid}/role`);
    const snapshot = await get(roleRef);

    if (snapshot.exists()) {
      // âœ… ROLE BOR â†’ avtomatik yoâ€˜naltirish
      const role = snapshot.val();
      redirect(role);
    } else {
      // â— ROLE YOâ€˜Q â†’ tanlashni KOâ€˜RSAT
      roleBox.style.display = "block";
    }
  });

  teacherBtn.addEventListener("click", async () => {
    await saveRole("teacher");
  });

  studentBtn.addEventListener("click", async () => {
    await saveRole("student");
  });

  async function saveRole(role) {
    const user = auth.currentUser;
    if (!user) return;

    await set(ref(db, `users/${user.uid}/role`), role);
    redirect(role);
  }

  function redirect(role) {
    if (role === "teacher") {
      location.href = "/teacher.html";
    } else {
      location.href = "/student.html";
    }
  }
</script>
