<script type="module">
import { auth, database, onAuthStateChanged } from "./firebase-config.js";
import { ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const teacherBtn = document.getElementById("teacherBtn");
const studentBtn = document.getElementById("studentBtn");
const loader = document.getElementById("loader");

teacherBtn.disabled = true;
studentBtn.disabled = true;

function redirect(role) {
  if (role === "teacher") {
    location.href = "teacher.html";
  } else if (role === "student") {
    location.href = "student.html";
  }
}

async function saveRole(role) {
  if (!auth.currentUser) return;

  loader.style.display = "block";

  await update(
    ref(database, "users/" + auth.currentUser.uid),
    { role }
  );

  redirect(role);
}

teacherBtn.onclick = () => saveRole("teacher");
studentBtn.onclick = () => saveRole("student");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "signin.html";
    return;
  }

  const roleSnap = await get(
    ref(database, "users/" + user.uid + "/role")
  );

  if (roleSnap.exists()) {
    redirect(roleSnap.val());
  } else {
    teacherBtn.disabled = false;
    studentBtn.disabled = false;
  }
});
</script>
