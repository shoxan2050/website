<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Major</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#020617;
  color:#e5e7eb;
}
header{
  padding:20px;
  background:#020617;
  border-bottom:1px solid #334155;
  display:flex;
  justify-content:space-between;
}
button{
  padding:16px 24px;
  font-size:18px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  background:#38bdf8;
  color:#020617;
  font-weight:700;
  margin:10px;
}
.panel{padding:30px}
.hidden{display:none}
.card{
  background:#020617;
  border:1px solid #334155;
  border-radius:18px;
  padding:30px;
  margin-bottom:20px;
}
input{
  padding:14px;
  font-size:18px;
  width:100%;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#fff;
  margin-bottom:10px;
}
</style>
</head>

<body>

<header>
  <div id="userName">...</div>
  <button onclick="logout()">Chiqish</button>
</header>

<!-- ROLE TANLASH -->
<div id="roleSelect" class="panel hidden">
  <h1>O‘qituvchimisiz?</h1>
  <button onclick="setRole('teacher')">Ha</button>
  <button onclick="setRole('student')">Yo‘q</button>
</div>

<!-- TEACHER PANEL -->
<div id="teacherPanel" class="panel hidden">
  <h1>O‘qituvchi paneli</h1>

  <div class="card">
    <h2>Kod yaratish</h2>
    <input id="newCode" placeholder="Masalan: 7777">
    <input id="question" placeholder="Savol">
    <input id="answer" placeholder="To‘g‘ri javob (a/b/c/d)">
    <button onclick="createCode()">Saqlash</button>
  </div>

  <div class="card">
    <h2>Mening kodlarim</h2>
    <div id="myCodes"></div>
  </div>
</div>

<!-- STUDENT PANEL -->
<div id="studentPanel" class="panel hidden">
  <h1>O‘quvchi sahifasi</h1>

  <div class="card">
    <h2>Kodni kiriting</h2>
    <input id="enterCode" placeholder="Masalan: 7777">
    <button onclick="loadTest()">Boshlash</button>
  </div>

  <div id="testBox" class="card hidden"></div>

  <div class="card">
    <h2>Statistika</h2>
    <p>To‘g‘ri: <span id="statCorrect">0</span>%</p>
    <p>Xato: <span id="statWrong">0</span>%</p>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCy8SLCFTgc_mB8B4JJqrUGsX5Lr2NUuPo",
  authDomain: "space0411-a00b1.firebaseapp.com",
  databaseURL: "https://space0411-a00b1-default-rtdb.firebaseio.com",
  projectId: "space0411-a00b1"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let currentUser;
let currentTest;

auth.onAuthStateChanged(async user=>{
  if(!user){ location.href="/signin.html"; return; }
  currentUser=user;

  const snap = await db.ref("users/"+user.uid).once("value");
  const data = snap.val();

  userName.textContent = data.firstName+" "+data.lastName;

  if(!data.role){
    roleSelect.classList.remove("hidden");
  }else{
    loadRole(data.role);
  }
});

function setRole(role){
  db.ref("users/"+currentUser.uid).update({role});
  loadRole(role);
}

function loadRole(role){
  roleSelect.classList.add("hidden");
  teacherPanel.classList.toggle("hidden", role!=="teacher");
  studentPanel.classList.toggle("hidden", role!=="student");
  if(role==="teacher") loadMyCodes();
}

function logout(){
  auth.signOut();
}

///// TEACHER /////
function createCode(){
  const code=newCode.value.trim();
  const q=question.value.trim();
  const a=answer.value.trim().toLowerCase();
  if(!code||!q||!a) return alert("To‘ldiring");

  db.ref("codes/"+code).set({
    ownerUid: currentUser.uid,
    questions:[q],
    answers:[a]
  });
  alert("Saqlanib bo‘ldi");
  loadMyCodes();
}

function loadMyCodes(){
  myCodes.innerHTML="";
  db.ref("codes").once("value",snap=>{
    snap.forEach(c=>{
      if(c.val().ownerUid===currentUser.uid){
        myCodes.innerHTML+=`<p>Kod: ${c.key}</p>`;
      }
    });
  });
}

///// STUDENT /////
function loadTest(){
  const code=enterCode.value.trim();
  db.ref("codes/"+code).once("value",snap=>{
    if(!snap.exists()) return alert("Kod topilmadi");
    currentTest=snap.val();
    showQuestion(0,code);
  });
}

function showQuestion(i,code){
  testBox.classList.remove("hidden");
  testBox.innerHTML=`
    <h3>${currentTest.questions[i]}</h3>
    <input id="userAns">
    <button onclick="check('${code}',${i})">Enter</button>
  `;
}

function check(code,i){
  const ans=userAns.value.trim().toLowerCase();
  let correct=ans===currentTest.answers[i];
  db.ref("results/"+code+"/"+currentUser.uid).set({
    correct: correct?1:0,
    total:1
  });
  statCorrect.textContent = correct?100:0;
  statWrong.textContent = correct?0:100;
  testBox.innerHTML= correct ? "✅ To‘g‘ri" : "❌ Xato";
}
</script>

</body>
</html>
