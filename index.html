<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>O'qituvchi va O'quvchilar Sayti</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body {
      margin: 0; padding: 20px; font-family: Arial, sans-serif;
      background: linear-gradient(45deg, #0a0a0a, #1a1a1a, #ff3333, #00ccff, #33ff33, #0a0a0a);
      background-size: 600%;
      color: #00ccff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      animation: backgroundMove 8s ease infinite;
    }
    @keyframes backgroundMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      background: rgba(0,0,0,0.8);
      padding: 30px;
      border-radius: 15px;
      width: 500px;
      max-width: 90%;
      box-shadow: 0 0 15px #00ccff;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 80%;
      border-radius: 5px;
      border: 2px solid #00ccff;
      background: transparent;
      color: #e6f3ff;
      font-size: 16px;
    }
    button {
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #00ccff;
      color: #000;
    }
    .hidden { display: none; }
    ul { list-style: none; padding-left: 0; text-align: left; }
    li.correct { color: #33ff33; font-weight: bold; }
    li.wrong { color: #ff3333; }
    #developer-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 12px;
      padding: 5px 10px;
      background: transparent;
      border: 2px solid #00ccff;
      border-radius: 5px;
      cursor: pointer;
      color: #00ccff;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <button id="developer-btn">Developer</button>

  <div class="container" id="user-info-section">
    <h2>Ismingizni kiriting</h2>
    <input type="text" id="first-name" placeholder="Ism" />
    <h2>Familiyangizni kiriting</h2>
    <input type="text" id="last-name" placeholder="Familiya" />
    <button id="submit-user-info">Davom etish</button>
  </div>

  <div class="container hidden" id="main-section">
    <h2>Kodni kiriting</h2>
    <input type="text" id="code-input" placeholder="Masalan: 34" />
    <button id="submit-code">Kiriting</button>
    <p id="error-msg" class="hidden" style="color:#ff3333;"></p>

    <div id="test-section" class="hidden">
      <h3>Test savollariga javob bering</h3>
      <form id="answers-form"></form>
      <button id="submit-answers">Tayyor</button>
    </div>

    <div id="result-section" class="hidden">
      <h3>Natija</h3>
      <ul id="result-list"></ul>
    </div>
  </div>

  <!-- Admin panel -->
  <div class="container hidden" id="admin-panel">
    <h2>Admin Panel</h2>
    <div id="tests-list"></div>
    <button id="logout-admin">Chiqish</button>
  </div>

  <script>
    // Firebase konfiguratsiyasi (o'zingiznikiga moslang)
    const firebaseConfig = {
      apiKey: "AIzaSyAYbHeM6nDZgIdYBbxtxQvx4S0npE8lRwk",
      authDomain: "requered.firebaseapp.com",
      databaseURL: "https://requered-default-rtdb.firebaseio.com",
      projectId: "requered",
      storageBucket: "requered.firebasestorage.app",
      messagingSenderId: "190052300320",
      appId: "1:190052300320:web:c81b8280922d86e9312e45",
      measurementId: "G-8HMEKXL9G3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM elementlar
    const userInfoSection = document.getElementById('user-info-section');
    const mainSection = document.getElementById('main-section');
    const adminPanel = document.getElementById('admin-panel');

    const firstNameInput = document.getElementById('first-name');
    const lastNameInput = document.getElementById('last-name');
    const submitUserInfoBtn = document.getElementById('submit-user-info');

    const codeInput = document.getElementById('code-input');
    const submitCodeBtn = document.getElementById('submit-code');
    const errorMsg = document.getElementById('error-msg');

    const testSection = document.getElementById('test-section');
    const answersForm = document.getElementById('answers-form');
    const submitAnswersBtn = document.getElementById('submit-answers');

    const resultSection = document.getElementById('result-section');
    const resultList = document.getElementById('result-list');

    const developerBtn = document.getElementById('developer-btn');

    const testsListDiv = document.getElementById('tests-list');
    const logoutAdminBtn = document.getElementById('logout-admin');

    // Global holatlar
    let currentUser = null; // {firstName, lastName}
    let currentTestCode = null;
    let currentTestData = null;

    // User info submit
    submitUserInfoBtn.onclick = () => {
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      if(!firstName || !lastName) {
        alert('Ism va Familiya kiritilishi shart!');
        return;
      }
      currentUser = { firstName, lastName };
      userInfoSection.classList.add('hidden');
      mainSection.classList.remove('hidden');
    };

    // Kod kiritilganda testni yuklash
    submitCodeBtn.onclick = () => {
      const code = codeInput.value.trim();
      if(!code) {
        errorMsg.textContent = 'Iltimos, kod kiriting!';
        errorMsg.classList.remove('hidden');
        return;
      }
      errorMsg.classList.add('hidden');
      loadTest(code);
    };

    function loadTest(code) {
      db.ref('tests/' + code).get().then(snapshot => {
        if (!snapshot.exists()) {
          errorMsg.textContent = 'Bunday test topilmadi!';
          errorMsg.classList.remove('hidden');
          testSection.classList.add('hidden');
          return;
        }
        currentTestCode = code;
        currentTestData = snapshot.val();
        showTestForm(currentTestData.questions);
      }).catch(() => {
        errorMsg.textContent = 'Xatolik yuz berdi. Internetni tekshiring.';
        errorMsg.classList.remove('hidden');
      });
    }

    function showTestForm(questions) {
      answersForm.innerHTML = '';
      questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.style.marginBottom = '15px';

        const label = document.createElement('label');
        label.textContent = `${i+1}. ${q}`;
        label.style.display = 'block';
        label.style.marginBottom = '5px';

        const input = document.createElement('input');
        input.type = 'text';
        input.name = 'answer-' + i;
        input.required = true;
        input.style.width = '100%';

        div.appendChild(label);
        div.appendChild(input);
        answersForm.appendChild(div);
      });
      testSection.classList.remove('hidden');
      resultSection.classList.add('hidden');
    }

    // Javoblarni yuborish
    submitAnswersBtn.onclick = () => {
      if(!currentTestData) return;
      const formData = new FormData(answersForm);
      const userAnswers = [];
      for(let i = 0; i < currentTestData.questions.length; i++) {
        const answer = formData.get('answer-' + i);
        if(!answer || answer.trim() === '') {
          alert('Barcha savollarga javob berish shart!');
          return;
        }
        userAnswers.push(answer.trim());
      }
      saveAnswers(currentTestCode, currentUser, userAnswers);
    };

    // Javoblarni Firebase'ga yozish va natijani hisoblash
    function saveAnswers(code, user, answers) {
      // Avval user ma'lumotlarini saqlaymiz
      const userId = user.firstName.toLowerCase() + '_' + user.lastName.toLowerCase();
      db.ref('users/' + userId).set(user);

      // Javoblarni saqlaymiz
      db.ref('answers/' + code + '/' + userId).set(answers).then(() => {
        showResult(answers);
      }).catch(() => {
        alert('Javoblarni saqlashda xatolik yuz berdi!');
      });
    }

    // Natijani hisoblash va ko'rsatish
    function showResult(userAnswers) {
      const correctAnswers = currentTestData.correctAnswers;
      resultList.innerHTML = '';
      let correctCount = 0;
      for(let i = 0; i < correctAnswers.length; i++) {
        const li = document.createElement('li');
        if(userAnswers[i].toLowerCase() === correctAnswers[i].toLowerCase()) {
          li.textContent = `${i+1}. To'g'ri javob: ${userAnswers[i]}`;
          li.classList.add('correct');
          correctCount++;
        } else {
          li.textContent = `${i+1}. Noto'g'ri javob: ${userAnswers[i]} | To'g'ri javob: ${correctAnswers[i]}`;
          li.classList.add('wrong');
        }
        resultList.appendChild(li);
      }
      const summary = document.createElement('p');
      summary.style.marginTop = '15px';
      summary.style.fontWeight = 'bold';
      summary.textContent = `To'g'ri javoblar soni: ${correctCount} / ${correctAnswers.length}`;
      resultList.appendChild(summary);

      resultSection.classList.remove('hidden');
    }

    // Developer / Admin panel ochish
    developerBtn.onclick = () => {
      const pass = prompt('Admin parolini kiriting:');
      if(pass === 'admin123') {
        userInfoSection.classList.add('hidden');
        mainSection.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        loadAdminPanel();
      } else {
        alert('Noto\'g\'ri parol!');
      }
    };

    // Admin panel ma'lumotlarini yuklash
    function loadAdminPanel() {
      testsListDiv.innerHTML = '<h3>Testlar ro\'yxati</h3>';

      db.ref('tests').get().then(snapshot => {
        if(!snapshot.exists()) {
          testsListDiv.innerHTML += '<p>Hech qanday test mavjud emas.</p>';
          return;
        }
        const tests = snapshot.val();
        for(const code in tests) {
          const div = document.createElement('div');
          div.style.border = '1px solid #00ccff';
          div.style.padding = '10px';
          div.style.marginBottom = '10px';
          div.style.background = 'rgba(0,0,0,0.7)';

          const h4 = document.createElement('h4');
          h4.textContent = `Test kodi: ${code}`;
          div.appendChild(h4);

          // Ko'rsatish: savollar
          const questionsUl = document.createElement('ul');
          tests[code].questions.forEach((q, i) => {
            const li = document.createElement('li');
            li.textContent = `Savol ${i+1}: ${q}`;
            questionsUl.appendChild(li);
          });
          div.appendChild(questionsUl);

          // Javoblarni olish
          const btn = document.createElement('button');
          btn.textContent = 'Javoblarni ko\'rish';
          btn.onclick = () => {
            loadAnswersForTest(code, div);
          };
          div.appendChild(btn);

          testsListDiv.appendChild(div);
        }
      });
    }

    // Berilgan test uchun javoblarni yuklash va ko'rsatish
    function loadAnswersForTest(code, containerDiv) {
      // Agar javoblar ro'yxati allaqachon bor bo'lsa, o'chirib qo'yamiz
      const oldAnswersDiv = containerDiv.querySelector('.answers-list');
      if(oldAnswersDiv) {
        oldAnswersDiv.remove();
        return;
      }

      const answersDiv = document.createElement('div');
      answersDiv.classList.add('answers-list');
      answersDiv.style.marginTop = '10px';
      answersDiv.style.padding = '10px';
      answersDiv.style.borderTop = '1px solid #00ccff';
      answersDiv.style.maxHeight = '200px';
      answersDiv.style.overflowY = 'auto';

      answersDiv.textContent = 'Yuklanmoqda...';
      containerDiv.appendChild(answersDiv);

      db.ref('answers/' + code).get().then(snapshot => {
        if(!snapshot.exists()) {
          answersDiv.textContent = 'Hech qanday javoblar topilmadi.';
          return;
        }
        answersDiv.textContent = '';
        const answers = snapshot.val();
        for(const userId in answers) {
          const userAnswers = answers[userId];
          const userLi = document.createElement('div');
          userLi.style.borderBottom = '1px solid #00ccff';
          userLi.style.padding = '5px 0';

          // User nomini olish
          db.ref('users/' + userId).get().then(userSnap => {
            const user = userSnap.exists() ? userSnap.val() : {firstName: 'Noma\'lum', lastName: ''};
            const userName = user.firstName + ' ' + user.lastName;
            userLi.innerHTML = `<b>${userName}</b>: ${userAnswers.join(', ')}`;
          });

          answersDiv.appendChild(userLi);
        }
      });
    }

    // Admin chiqishi
    logoutAdminBtn.onclick = () => {
      adminPanel.classList.add('hidden');
      userInfoSection.classList.remove('hidden');
      firstNameInput.value = '';
      lastNameInput.value = '';
      codeInput.value = '';
      testSection.classList.add('hidden');
      resultSection.classList.add('hidden');
      currentUser = null;
      currentTestCode = null;
      currentTestData = null;
    }
  </script>

</body>
</html>
