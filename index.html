<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>O'qituvchi va O'quvchilar Sayti</title>

  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    /* CSS siz kiritgan uslubga mos */
    body {
        margin: 0;
        padding: 20px;
        font-family: 'Arial', sans-serif;
        background: linear-gradient(45deg, #0a0a0a, #1a1a1a, #ff3333, #00ccff, #33ff33, #0a0a0a);
        background-size: 600%;
        color: #00ccff;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        animation: backgroundMove 8s ease infinite;
    }
    @keyframes backgroundMove {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    @keyframes neon-glow {
        0% { text-shadow: 0 0 3px #00ccff, 0 0 5px #00ccff, 0 0 10px #00ccff; color: #00ccff; }
        50% { text-shadow: 0 0 5px #00ccff, 0 0 8px #00ccff, 0 0 12px #00ccff; color: #99e6ff; }
        100% { text-shadow: 0 0 3px #00ccff, 0 0 5px #00ccff, 0 0 10px #00ccff; color: #00ccff; }
    }
    .neon-text {
        animation: neon-glow 2s ease-in-out infinite;
    }
    .container {
        text-align: center;
        background: rgba(0, 0, 0, 0.8);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0, 204, 255, 0.4);
        max-width: 600px;
        width: 90%;
        margin: 20px auto;
    }
    input[type="text"], input[type="password"] {
        padding: 10px;
        width: 80%;
        margin: 10px 0;
        border: 2px solid #00ccff;
        background: rgba(255, 255, 255, 0.1);
        color: #e6f3ff;
        border-radius: 5px;
        font-size: 16px;
    }
    button {
        padding: 10px 20px;
        background: transparent;
        border: 2px solid #00ccff;
        color: #e6f3ff;
        cursor: pointer;
        border-radius: 5px;
        margin: 10px;
        transition: all 0.3s;
    }
    button:hover {
        background: #00ccff;
        color: #000;
        box-shadow: 0 0 10px #00ccff;
    }
    .error {
        color: #ff3333;
        text-shadow: 0 0 3px #ff3333;
    }
    .hidden {
        display: none;
    }
    #test-section, #admin-section {
        margin-top: 20px;
        text-align: left;
    }
    #test-questions > div {
        margin-bottom: 15px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    #result-section {
        margin-top: 20px;
        background: rgba(0,0,0,0.7);
        padding: 15px;
        border-radius: 10px;
    }
    #result-section li.correct {
        color: #33ff33;
        font-weight: bold;
    }
    #result-section li.wrong {
        color: #ff3333;
        font-weight: bold;
    }
    #admin-tests-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #00ccff;
        padding: 10px;
        margin-bottom: 15px;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Foydalanuvchi ma'lumotlari -->
    <div id="user-info-section">
      <h1 class="neon-text">Ismingizni Kiriting</h1>
      <input type="text" id="first-name" placeholder="Ism" />
      <h1 class="neon-text">Familiyangizni Kiriting</h1>
      <input type="text" id="last-name" placeholder="Familiya" />
      <button id="submit-user-info">Davom Etish</button>
    </div>

    <!-- Kod kiritish -->
    <div id="main-section" class="hidden">
      <h1 class="neon-text">Kodni Kiriting</h1>
      <input type="text" id="code-input" placeholder="Masalan: 34 yoki admin123" />
      <button id="submit-code">Kiriting</button>
      <p id="error-msg" class="error hidden"></p>
    </div>

    <!-- Test ko'rsatish -->
    <div id="test-section" class="hidden">
      <h2 class="neon-text">Test Savollari</h2>
      <form id="test-form">
        <div id="test-questions"></div>
        <button type="submit">Javoblarni Tekshirish</button>
      </form>
      <div id="result-section" class="hidden"></div>
    </div>

    <!-- Admin panel -->
    <div id="admin-section" class="hidden">
      <h2 class="neon-text">Admin Panel</h2>
      <div id="admin-tests-list">
        <h3>Testlar ro'yxati:</h3>
        <ul id="tests-list"></ul>
      </div>

      <h3>Yangi test qo'shish</h3>
      <input type="text" id="new-test-code" placeholder="Test kodi" />
      <textarea id="new-test-questions" placeholder="Savollar va javoblar (format: savol|javob, har bir qator yangi savol)" rows="5" style="width: 80%;"></textarea>
      <button id="add-test-btn">Test Qo'shish</button>
      <p id="admin-msg" class="error hidden"></p>
    </div>
  </div>

  <script>
    // Firebase konfiguratsiyasi
    const firebaseConfig = {
      apiKey: "AIzaSyAYbHeM6nDZgIdYBbxtxQvx4S0npE8lRwk",
      authDomain: "requered.firebaseapp.com",
      databaseURL: "https://requered-default-rtdb.firebaseio.com",
      projectId: "requered",
      storageBucket: "requered.firebasestorage.app",
      messagingSenderId: "190052300320",
      appId: "1:190052300320:web:c81b8280922d86e9312e45",
      measurementId: "G-8HMEKXL9G3"
    };

    // Firebase ishga tushurish
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM elementlar
    const userInfoSection = document.getElementById('user-info-section');
    const mainSection = document.getElementById('main-section');
    const testSection = document.getElementById('test-section');
    const adminSection = document.getElementById('admin-section');

    const submitUserInfoBtn = document.getElementById('submit-user-info');
    const firstNameInput = document.getElementById('first-name');
    const lastNameInput = document.getElementById('last-name');

    const codeInput = document.getElementById('code-input');
    const submitCodeBtn = document.getElementById('submit-code');
    const errorMsg = document.getElementById('error-msg');

    const testForm = document.getElementById('test-form');
    const testQuestionsDiv = document.getElementById('test-questions');
    const resultSection = document.getElementById('result-section');

    const adminTestsList = document.getElementById('tests-list');
    const newTestCodeInput = document.getElementById('new-test-code');
    const newTestQuestionsInput = document.getElementById('new-test-questions');
    const addTestBtn = document.getElementById('add-test-btn');
    const adminMsg = document.getElementById('admin-msg');

    let currentUser = null;
    let currentCode = null;
    let currentTestData = null;

    // 1. Foydalanuvchi ma'lumotlari
    submitUserInfoBtn.addEventListener('click', () => {
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      if (!firstName || !lastName) {
        alert("Ism va Familiya kiritilishi shart!");
        return;
      }
      currentUser = { firstName, lastName };
      userInfoSection.classList.add('hidden');
      mainSection.classList.remove('hidden');
    });

    // 2. Kod kiritish va admin/foydalanuvchi tekshiruvi
    submitCodeBtn.addEventListener('click', () => {
      errorMsg.classList.add('hidden');
      const code = codeInput.value.trim();
      if (!code) {
        errorMsg.textContent = "Kod kiritilishi shart!";
        errorMsg.classList.remove('hidden');
        return;
      }

      if (code === 'admin123') {
        // Admin panel ochish
        currentCode = null;
        mainSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        testSection.classList.add('hidden');
        loadAllTestsForAdmin();
      } else {
        // Foydalanuvchi uchun test yuklash
        loadTestByCode(code);
      }
    });

    // 3. Test yuklash (foydalanuvchi uchun)
    function loadTestByCode(code) {
      database.ref('tests/' + code).get().then(snapshot => {
        if (!snapshot.exists()) {
          errorMsg.textContent = "Bunday kodli test topilmadi!";
          errorMsg.classList.remove('hidden');
          return;
        }
        currentCode = code;
        currentTestData = snapshot.val();
        mainSection.classList.add('hidden');
        adminSection.classList.add('hidden');
        testSection.classList.remove('hidden');
        renderTestQuestions(currentTestData.questions);
      }).catch(err => {
        errorMsg.textContent = "Xatolik yuz berdi: " + err.message;
        errorMsg.classList.remove('hidden');
      });
    }

    // 4. Test savollarini chiqarish
    function renderTestQuestions(questions) {
      testQuestionsDiv.innerHTML = '';
      questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.innerHTML = `
          <label for="answer-${i}">${i+1}. ${q.question}</label>
          <input type="text" id="answer-${i}" name="answer-${i}" required autocomplete="off" />
        `;
        testQuestionsDiv.appendChild(div);
      });
      resultSection.classList.add('hidden');
      testForm.scrollIntoView({behavior: 'smooth'});
    }

    // 5. Javoblarni tekshirish
    testForm.addEventListener('submit', e => {
      e.preventDefault();
      const answers = [];
      let correctCount = 0;
      const total = currentTestData.questions.length;
      const wrongDetails = [];

      for(let i=0; i<total; i++) {
        const userAnswer = testForm[`answer-${i}`].value.trim().toLowerCase();
        const correctAnswer = currentTestData.questions[i].answer.trim().toLowerCase();
        answers.push(userAnswer);
        if(userAnswer === correctAnswer) {
          correctCount++;
        } else {
          wrongDetails.push({
            question: currentTestData.questions[i].question,
            yourAnswer: userAnswer,
            correctAnswer: currentTestData.questions[i].answer
          });
        }
      }

      // Natijani ko'rsatish
      let resultHTML = `<p>To'g'ri javoblar: <strong>${correctCount}</strong> / ${total}</p><ul>`;
      currentTestData.questions.forEach((q, i) => {
        const userAnswer = answers[i];
        const isCorrect = userAnswer === q.answer.trim().toLowerCase();
        resultHTML += `<li class="${isCorrect ? 'correct' : 'wrong'}">${i+1}. ${q.question}<br>Javobingiz: <strong>${userAnswer || "(bo'sh)"}</strong>`;
        if(!isCorrect){
          resultHTML += `<br>To'g'ri javob: <strong>${q.answer}</strong>`;
        }
        resultHTML += `</li>`;
      });
      resultHTML += '</ul>';

      if (wrongDetails.length > 0) {
        resultHTML += `<p>Qayta ko'rib chiqing!</p>`;
      } else {
        resultHTML += `<p>Tabriklaymiz! Barcha javoblar to'g'ri.</p>`;
      }

      resultSection.innerHTML = resultHTML;
      resultSection.classList.remove('hidden');

      // Javoblarni Firebase ga yozish (results/{code}/{foydalanuvchi_id})
      const userId = `${currentUser.firstName}_${currentUser.lastName}_${Date.now()}`;
      database.ref(`results/${currentCode}/${userId}`).set({
        user: currentUser,
        answers,
        correctCount,
        total,
        timestamp: Date.now()
      });
    });

    // 6. Admin panel uchun testlarni yuklash
    function loadAllTestsForAdmin() {
      adminMsg.classList.add('hidden');
      adminTestsList.innerHTML = '';
      database.ref('tests').get().then(snapshot => {
        if (!snapshot.exists()) {
          adminTestsList.innerHTML = '<li>Hozircha testlar mavjud emas.</li>';
          return;
        }
        const tests = snapshot.val();
        for (const code in tests) {
          const li = document.createElement('li');
          li.textContent = `Kod: ${code} | Savollar soni: ${tests[code].questions.length}`;
          adminTestsList.appendChild(li);
        }
      }).catch(err => {
        adminMsg.textContent = "Xatolik yuz berdi: " + err.message;
        adminMsg.classList.remove('hidden');
      });
    }

    // 7. Yangi test qo'shish
    addTestBtn.addEventListener('click', () => {
      adminMsg.classList.add('hidden');
      const code = newTestCodeInput.value.trim();
      const questionsRaw = newTestQuestionsInput.value.trim();

      if (!code || !questionsRaw) {
        adminMsg.textContent = "Iltimos, test kodi va savollarni to'liq kiriting.";
        adminMsg.classList.remove('hidden');
        return;
      }

      // Savollarni qayta ishlash: har qator "savol|javob"
      const lines = questionsRaw.split('\n');
      const questions = [];
      for (let line of lines) {
        const parts = line.split('|');
        if(parts.length !== 2){
          adminMsg.textContent = "Har bir qatorda 'savol|javob' formatida bo'lishi kerak.";
          adminMsg.classList.remove('hidden');
          return;
        }
        questions.push({question: parts[0].trim(), answer: parts[1].trim()});
      }

      // Testni Firebase ga qo'shish
      database.ref('tests/' + code).set({questions}).then(() => {
        adminMsg.style.color = 'lightgreen';
        adminMsg.textContent = "Test muvaffaqiyatli qo'shildi!";
        adminMsg.classList.remove('hidden');

        // Tahrir qutilarini tozalash
        newTestCodeInput.value = '';
        newTestQuestionsInput.value = '';

        loadAllTestsForAdmin();
      }).catch(err => {
        adminMsg.style.color = 'red';
        adminMsg.textContent = "Test qo'shishda xatolik yuz berdi: " + err.message;
        adminMsg.classList.remove('hidden');
      });
    });
  </script>

</body>
</html>
